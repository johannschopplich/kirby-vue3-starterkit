<p align="center">
  <img src="./public/img/favicon.svg" alt="Logo of Kirby + Vue.js 3 Starterkit" width="114" height="114">
</p>

<h3 align="center">Kirby + Vue.js 3 Starterkit</h3>

<p align="center">
  SPA with Vue.js 3 and Kirby. Uses Vite as web dev build tool.<br>
  <a href="https://kirby-vue3-starterkit.jhnn.dev"><strong>Explore the starterkit live Â»</strong></a>
</p>

<br>

## Kirby + Vue.js 3 Starterkit

### Key Features

- ğŸ–– Vue.js 3 powered
- âš¡ï¸ [Vite](https://github.com/vitejs/vite) instead of Vue.js CLI
- â™¿ Accessible routing
- ğŸ” SEO-friendly ([server-side generated](site/snippets/meta.php) meta tags)
- ğŸš [Offline-first](#caching--offline-capability-with-service-worker): Page data caching & offline redirection
- ğŸ’« [Stale-while-revalidate](#stale-while-revalidate) page data
- ğŸ—ƒï¸ Centralized state management without Vuex
- ğŸ¤ Shared [`.env`](.env.example) file for frontend & backend
- ğŸš€ Modern Kirby folder setup

### Introduction

This project is a starting point for [Vue.js v3](https://github.com/vuejs/vue-next) as the frontend UI library and [Kirby](https://getkirby.com) as headless CMS. The content is provided as JSON through Kirby and fetched by the frontend.

It's a simple, zero-setup, almost identical port of the [Kirby 3 starterkit](https://github.com/getkirby/starterkit) frontend (snippets, templates and their corresponding JS/CSS) to Vue.js single file components. By "almost" meaning that some features have been added like meta tags generation, environment variables support, accessible routing etc.

To compile the frontend sources, [Vite](https://github.com/vitejs/vite) comes to use. Vite is an opinionated web development build tool, created by Evan You. It serves code via native ES Module imports during development, allowing you to develop Vue.js single file components without a bundle step, and bundles it with Rollup for production. Features include:
- Lightning fast cold server start
- Instant hot module replacement (HMR)
- [Head over to the GitHub page](https://github.com/vitejs/vite) for more details

### Lighthouse Report

![Lighthouse Report](./.github/lighthouse-report.png)

### Folder Structure

Some notes about the folder structure with some additional comments on important files.

<details>
<summary><b>Expand folder tree</b></summary>

```sh
kirby-vue3-starterkit/
|
|   # Includes all frontend-related files
â”œâ”€â”€ frontend/
|   |
|   |   # Vue.js sources
|   â”œâ”€â”€ src/
|   |   |
|   |   |   # `Header`, `Footer`, `Intro` and other components
|   |   |   # (Vue.js components correspond to Kirby snippets)
|   |   â”œâ”€â”€ components/
|   |   |
|   |   |   # Commonly used helpers
|   |   â”œâ”€â”€ helpers/
|   |   |
|   |   |   # Hooks for common actions
|   |   â”œâ”€â”€ hooks/
|   |   |   |
|   |   |   |   # Hook to announce any useful information for screen readers
|   |   |   â”œâ”€â”€ useAnnouncer.js
|   |   |   |
|   |   |   |   # Hook for retrieving pages from the content API
|   |   |   â”œâ”€â”€ useKirbyApi.js
|   |   |   |
|   |   |   |   # Hook returning the page for current path, similarly to Kirby's `$page` object
|   |   |   â”œâ”€â”€ usePage.js
|   |   |   |
|   |   |   |   # Hook for various service worker methods like registering
|   |   |   â”œâ”€â”€ useServiceWorker.js
|   |   |   |
|   |   |   |   # Hook returning a object corresponding to Kirby's global `$site`
|   |   |   â””â”€â”€ useSite.js
|   |   |
|   |   |   # Custom Vue plugins
|   |   â”œâ”€â”€ plugins/
|   |   |   |
|   |   |   |   # Adds a `v-kirbytext` directive to handle internal page links inside KirbyText
|   |   |   â””â”€â”€ KirbyTextDirective.js
|   |   |
|   |   |   # Vue Router related methods and exports
|   |   â”œâ”€â”€ router/
|   |   |   |
|   |   |   |   # Initializes and exports the router instance
|   |   |   â”œâ”€â”€ index.js
|   |   |   |
|   |   |   |   # Handles the router's scroll behaviour
|   |   |   â””â”€â”€ scrollBehaviour.js
|   |   |
|   |   |   # Minimal store to cache page data fetched via api
|   |   â”œâ”€â”€ store/
|   |   |
|   |   |   # Vue.js views corresponding to Kirby templates
|   |   |   # Routes are being automatically resolved
|   |   â”œâ”€â”€ views/
|   |   |
|   |   â”œâ”€â”€ App.vue
|   |   â”œâ”€â”€ main.js
|   |   â””â”€â”€ serviceWorker.js
|   |
|   |   # Index page used by Vite in development environment
|   â””â”€â”€ index.html
|
|   # Main entry point of the website, point your web server to this directory
â”œâ”€â”€ public/
|   |
|   |   # JavaScript and CSS assets generated by Vite (not tracked by Git)
|   â”œâ”€â”€ assets/
|   |
|   |   # Static images like PWA icons
|   â”œâ”€â”€ img/
|   |
|   |   # Kirby's media folder for thumbnails and more (content not tracked by Git)
|   â””â”€â”€ media/
|
|   # Various development-centric Node scripts
â”œâ”€â”€ scripts/
|   |
|   |   # Service worker generator
|   â”œâ”€â”€ buildServiceWorker.js
|   |
|   |   # Starts a PHP server for Kirby, run by `npm run kirby:serve` from root
|   â””â”€â”€ serveKirby.js
|
|   # Kirby's core folder containing templates, blueprints, snippets etc. for Kirby
â”œâ”€â”€ site/
|   â”œâ”€â”€ blueprints/
|   â”œâ”€â”€ config/
|   |   |
|   |   |   # General Kirby configuration settings and configuration settings for plugins
|   |   â”œâ”€â”€ config.php
|   |   |
|   |   |   # Place custom routes for your project in here
|   |   â”œâ”€â”€ routes.php
|   |   |
|   |   |   # Builds a JSON-encoded `site` object for the frontend
|   |   |   # Used by Vue Router to populate routes, but can be extended by commonly used data
|   |   â””â”€â”€ site.php
|   |
|   â”œâ”€â”€ models/
|   â”œâ”€â”€ plugins/spa-adapter/
|   |   |
|   |   |   # Core of the SPA integration plugin, mainly registeres routes
|   |   â”œâ”€â”€ index.php
|   |   |
|   |   |   # Routes to handle `.json` requests and serving the `index.php` snippet
|   |   â””â”€â”€ routes.php
|   |
|   â”œâ”€â”€ snippets/
|   |   |
|   |   |   # Index page used in production environment â€“ almost identical to `frontend/index.html`
|   |   |   # Handles build asset paths, inlines the `site` object, includes SEO meta tags, etc.
|   |   â””â”€â”€ index.php
|   |
|   |   # Templates for JSON content representations fetched by frontend
|   â””â”€â”€ templates/
|
|   # Contains everything content and user data related (contents not tracked by Git)
â”œâ”€â”€ storage/
|   â”œâ”€â”€ accounts/
|   â”œâ”€â”€ cache/
|   â”œâ”€â”€ content/
|   â””â”€â”€ sessions/
|
|   # Kirby CMS and other PHP dependencies (handled by Composer)
â”œâ”€â”€ vendor/
|
|   # Environment variables for both Kirby and Vite (to be duplicated as `.env`)
â”œâ”€â”€ .env.example
|
|   # Handles PHP dependencies
â”œâ”€â”€ composer.json
|
|   # Handles NPM dependencies
â”œâ”€â”€ package.json
|
|   # Router for the PHP built-in development server (used by `serveKirby.js`)
â”œâ”€â”€ server.php
|
|   # Configuration file for Vite
â””â”€â”€ vite.config.js
```

</details>

## Caching & Offline Capability With Service Worker

Even without a service worker installed, the frontend will store pages between indiviual routes/views ([in-memory store](frontend/src/store/kirbyStore.js)). When you reload the tab, the data for each page is freshly fetched from the API once again.

For offline capability of your Vue app, you can choose to activate the included [service worker](frontend/src/serviceWorker.js).

A visual explanation of both methods can be found in the following flow chart:

![Caching for Kirby and Vue 3 starterkit](./.github/kirby-vue-3-cache-and-store.png)

The service worker precaches all CSS & JS assets required by the Vue app and caches the data of every requested page. All assets are versioned and served from the service worker cache directly.

Each JSON request will be freshly fetched from the network and saved to the cache. If the user's navigator turns out to be offline, the cached page request will be returned.

## Stale-While-Revalidate

The stale-while-revalidate mechanism for the [`usePage`](frontend/src/hooks/usePage.js) hook allows you to respond as quickly as possible with cached page data if available, falling back to the network request if it's not cached. The network request is then used to update the cached page data â€“ which directly affects the view after lazily assigning changes (if any), thanks to Vue's reactivity.

## Prerequisites

- Node.js with npm (only required to build the frontend)
- PHP 7.4+

> Kirby is not a free software. You can try it for free on your local machine but in order to run Kirby on a public server you must purchase a [valid license](https://getkirby.com/buy).

## Setup

1. Duplicate the [`.env.example`](.env.example) as `.env` and optionally adapt its values:

```bash
cp .env.example .env
```

2. Install npm dependencies:

```bash
npm install
```

**Note**: Composer dependencies are tracked in this repository by default. Running `composer install` isn't necessary.

## Usage

### Serve Backend & Frontend for Development

```bash
# Runs `npm run kirby:serve` and `npm run dev` in parallel
npm run start
```

Out of the box the backend is automatically served while developing. `npm run kirby:serve` spawns the PHP built-in web server by Node. You can also serve the backend by a web server of your choice. If done so, please specify hostname and port in your `.env` if they differ from `localhost`and `8080` respectively so that the decoupled frontend can call the Kirby API for JSON content in development.

### Compile for Production

Build the frontend assets (CSS & JS files) to `public/assets`:

```bash
npm run build
```

**Note**: If you wish to target older browsers, run `npm run build:compat` which transpiles to `es2017`. For even older browsers, you can change the target in the `package.json`'s npm script.

### Configuration

All development and production related configurations for both backend and frontend code are located in your `.env` file:
- `KIRBY_SERVER_HOSTNAME` and `KIRBY_SERVER_PORT` specify the address where you wish the Kirby backend to be served from. It is used by the frontend to fetch content data as JSON.
- Keys starting with `VITE_` are available in your code following the `import.meta.env.VITE_CUSTOM_VARIABLE` syntax.

#### Content API Slug

To change the API slug to fetch JSON-encoded page data from, set
- `CONTENT_API_SLUG` to a value of your liking (defaults to `content`).

> You can't use Kirby's internal API slug (defaults to `api`). If you insist on using `api` for *your* content endpoint, you can rename the Kirby api slug: Add a `KIRBY_API_SLUG` key and set it to something else than `api`.

#### Service Worker

To enable the **service worker** which precaches essential assets and page API calls for offline capability, set:
- `VITE_ENABLE_SW` to `true`

> âš ï¸ Don't change the `CONTENT_API_SLUG` once you deployed your app publicly and thus a service worker is installed on clients. Otherwise fetch requests will fail and a blank page will show until the new service worker is activated, which then is only possible by closing the tab/PWA.

#### Stale-While-Revalidate

To keep page data fresh with **stale-while-revalidate**, set:
- `VITE_ENABLE_SWR` to `true`

### Deployment

1. Deploy whole repository on your server.
2. Duplicate [`.env.example`](.env.example) as `.env`.
3. Install npm dependencies and build frontend assets: `npm i && npm run build`.
4. Change variables in your `.env`:
   - `KIRBY_DEBUG` to `false`
   - `KIRBY_CACHE` to `true` (recommended)
   - `VITE_ENABLE_SW` to `true` (recommended)
5. Point your web server to the `public` folder.
6. Some hosting environments require to uncomment `RewriteBase /` in [`.htaccess`](public/.htaccess) to make site links work.

Now your project is hopefully up 'n' running!

## Credits

- Big thanks to Jakub MedveckÃ½ Heretik for his inspirational work on [kirby-vue-starterkit](https://github.com/jmheretik/kirby-vue-starterkit).
- Mario Brendl for his [article on a Vue 3 based store w/o Vuex](https://medium.com/@mario.brendel1990/vue-3-the-new-store-a7569d4a546f).

## License

[MIT](https://opensource.org/licenses/MIT)

It is discouraged to use this starterkit in any project that promotes racism, sexism, homophobia, animal abuse, violence or any other form of hate speech.
